<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 51 - Pickleball Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Available: Green/Teal */
        .slot-available {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        /* Confirmed/Booked: Red (as requested) */
        .slot-booked {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        /* Pending/In Cart: Yellow (New state) */
        .slot-pending {
            background: linear-gradient(135deg, #facc15, #eab308); /* Yellow gradient */
            color: #1f2937; /* Dark text for contrast */
        }
        /* Selected (visual only, before adding to cart) */
        .slot-available-selected {
            background: linear-gradient(135deg, #0d9488, #0f766e);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <header class="bg-black text-white p-4 shadow-xl sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex items-center justify-between flex-wrap gap-4">
            
            <div class="flex items-center space-x-3 cursor-pointer" id="adminTrigger">
                <div class="text-3xl">üéæ</div>
                <div>
                    <h1 class="text-lg sm:text-2xl font-extrabold">Area 51 Pickleball</h1>
                    <p class="text-xs sm:text-sm text-gray-400 hidden sm:block">Premium Court Booking System</p>
                </div>
            </div>

            <div class="flex space-x-3">
                <a href="https://maps.app.goo.gl/5dwYtzEj3mLkPxSd7" target="_blank" 
                   class="flex items-center bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold px-3 py-2 rounded-lg transition-colors shadow-md">
                    <span class="text-lg mr-1">üìç</span> Location
                </a>
                <button onclick="contactAdmin()" 
                        class="flex items-center bg-green-500 hover:bg-green-600 text-white text-sm font-semibold px-3 py-2 rounded-lg transition-colors shadow-md">
                    <span class="text-lg mr-1">üí¨</span> WhatsApp
                </button>
            </div>
            <div class="h-6 hidden sm:block"></div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto p-4 sm:p-6">
        
        <div id="bookingSection" class="">
            
            <div id="pickleballBooking" class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 mb-8 fade-in">
                <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Book Your Pickleball Court</h3>
                <div class="grid sm:grid-cols-2 gap-4 sm:gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Court Type</label>
                        <select id="courtType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition duration-150">
                            <option value="indoor">Indoor Court</option>
                            <option value="outdoor">Outdoor Court</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="pickleballDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition duration-150">
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="text-base sm:text-lg font-semibold mb-4 flex items-center space-x-3">
                        <span>Available Time Slots (‚Çπ500/hour)</span>
                        <span class="text-xs text-gray-500 font-normal">| Tap to Select</span>
                    </h4>
                    <div id="pickleballSlots" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 sm:gap-3">
                        <div class="col-span-full text-center py-8 text-gray-500 font-medium" id="loadingIndicator">
                            Loading bookings from server...
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg text-sm mb-6">
                    <p class="font-semibold text-blue-800 mb-1">Status Key:</p>
                    <div class="flex flex-wrap gap-4 text-xs">
                        <span class="px-2 py-1 rounded-full bg-green-500 text-white font-medium">Available</span>
                        <span class="px-2 py-1 rounded-full bg-yellow-500 text-gray-800 font-medium">Pending (Admin Approval)</span>
                        <span class="px-2 py-1 rounded-full bg-red-600 text-white font-medium">Confirmed/Booked</span>
                    </div>
                </div>
                
                <button onclick="addSelectedToCart()" id="addToCartBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-extrabold px-6 py-3 rounded-lg transition-colors text-lg shadow-lg hover:shadow-xl">
                    Add Selected Slots to Cart
                </button>
            </div>

            <div id="cartSection" class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Your Cart (Slots to be confirmed)</h3>
                <div id="cartItems" class="space-y-3 mb-4">
                    <p class="text-gray-500 text-base">No slots currently selected.</p>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center text-lg sm:text-xl font-bold">
                        <span>Total:</span>
                        <span id="cartTotal">‚Çπ0</span>
                    </div>
                    <button onclick="showUserDetailsForm()" id="checkoutBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg mt-4 transition-colors disabled:bg-gray-400 text-lg shadow-md" disabled>
                        Confirm Booking & Enter Details
                    </button>
                </div>
            </div>
        </div>

        <div id="adminSection" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Admin Dashboard</h3>
                
                <div class="grid sm:grid-cols-3 gap-4 sm:gap-6 mb-8">
                    <div class="bg-yellow-50 p-4 rounded-lg shadow-inner">
                        <h4 class="font-semibold text-yellow-800 text-sm">Pending Bookings</h4>
                        <p class="text-xl sm:text-2xl font-bold text-yellow-600" id="pendingBookingsCount">0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg shadow-inner">
                        <h4 class="font-semibold text-red-800 text-sm">Total Confirmed</h4>
                        <p class="text-xl sm:text-2xl font-bold text-red-600" id="confirmedBookingsCount">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg shadow-inner">
                        <h4 class="font-semibold text-green-800 text-sm">Total Revenue</h4>
                        <p class="text-xl sm:text-2xl font-bold text-green-600" id="totalRevenue">‚Çπ0</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg sm:text-xl font-semibold mb-3">All Bookings (Pending/Confirmed)</h4>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full border-collapse text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border-b px-3 py-3 text-left">Customer</th>
                                    <th class="border-b px-3 py-3 text-left">Date & Time</th>
                                    <th class="border-b px-3 py-3 text-left">Venue</th>
                                    <th class="border-b px-3 py-3 text-left">Price</th>
                                    <th class="border-b px-3 py-3 text-left">Status</th>
                                    <th class="border-b px-3 py-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                                <tr>
                                    <td colspan="6" class="px-4 py-4 text-center text-gray-500">No bookings yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <button onclick="exitAdmin()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                    Exit Admin
                </button>
            </div>
        </div>
    </div>

    <div id="userDetailsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 sm:p-8 max-w-lg mx-4 text-center fade-in shadow-2xl">
            <h2 class="text-2xl font-bold text-purple-600 mb-4">Complete Your Booking</h2>
            <p class="text-gray-600 mb-6">Please provide your details so that we can confirm your slot and contact you.</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">Your Full Name</label>
                    <input type="text" id="customerName" placeholder="E.g., John Doe" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div>
                    <label for="customerWhatsapp" class="block text-sm font-medium text-gray-700 mb-2">WhatsApp Number (+91)</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-100 text-gray-500 font-semibold">+91</span>
                        <input type="tel" id="customerWhatsapp" placeholder="10-digit number" 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-purple-500 transition"
                               maxlength="10" pattern="[0-9]{10}" required>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end space-x-3">
                <button onclick="closeUserDetailsModal()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition">
                    Cancel
                </button>
                <button onclick="submitUserDetails()" id="submitDetailsBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition disabled:bg-gray-400">
                    Confirm & Notify Admin
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // üõëüõëüõë IMPORTANT: REPLACE THESE WITH YOUR FIREBASE PROJECT CONFIG üõëüõëüõë
        const firebaseConfig = {
  apiKey: "AIzaSyAUO0JKEK3FIDm3plBlGJ0KgTJdO1U_flg",
  authDomain: "area51pickleball-6aa2e.firebaseapp.com",
  projectId: "area51pickleball-6aa2e",
  storageBucket: "area51pickleball-6aa2e.firebasestorage.app",
  messagingSenderId: "832417408847",
  appId: "1:832417408847:web:24102fc24f7e72aa28873a"
};
        
        // Initialize Firebase and Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // -----------------------------------------------------------------------

        // --- GLOBAL STATE & CONFIGURATION ---
        // Using localStorage only for a consistent user ID, NOT for bookings
        const userId = 'GUEST_USER_' + (localStorage.getItem('area51UserId') || Math.random().toString(36).substring(2, 9));
        localStorage.setItem('area51UserId', userId); 
        
        let currentUser = { phone: '9999999999', id: userId }; 
        
        // This array will be loaded from/saved to Firebase
        let bookings = []; 
        
        let selectedSlots = []; 
        let pendingBookingDraft = []; 
        
        const ADMIN_WHATSAPP = '917972409893';
        const AREA_51_LOCATION = 'https://maps.app.goo.gl/5dwYtzEj3mLkPxSd7'; 
        const SLOT_PRICE = 500;

        // --- FIREBASE DATA MANAGEMENT ---

        /**
         * üü¢ Replaces localStorage.setItem. Saves the current bookings array to Firestore.
         */
        async function saveBookings() {
            try {
                // Save the entire array under a single document ID ('data')
                await db.collection("area51Bookings").doc("data").set({ 
                    bookingsArray: bookings,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Bookings saved to Firebase!");
            } catch (error) {
                showMessage('Save Error', `Failed to save bookings: ${error.message}`, 'red');
                console.error("Error writing document: ", error);
            }
        }

        /**
         * üü¢ Replaces localStorage.getItem. Loads the bookings array from Firestore.
         */
        async function loadBookings() {
            try {
                const doc = await db.collection("area51Bookings").doc("data").get();
                if (doc.exists && doc.data().bookingsArray) {
                    bookings = doc.data().bookingsArray;
                    console.log("Bookings loaded from Firebase:", bookings.length);
                } else {
                    console.log("No initial data found in Firebase. Starting fresh.");
                }
            } catch (error) {
                showMessage('Load Error', `Failed to load bookings: ${error.message}`, 'red');
                console.error("Error reading document: ", error);
            }
        }
        
        // --- UTILITIES (Same as before) ---
        function formatDateToDisplay(dateString) {
            if (!dateString) return 'Invalid Date';
            try {
                const date = new Date(dateString + 'T00:00:00');
                const day = date.getDate().toString().padStart(2, '0');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (error) {
                return 'Invalid Date';
            }
        }

        function contactAdmin() {
            const message = "Hi, I have a general question about court bookings at Area 51 Pickleball.";
            const whatsappURL = `https://wa.me/${ADMIN_WHATSAPP}?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        }

        // Custom message box utility
        function showMessage(title, message, type = 'blue') {
            const bgColor = type === 'red' ? 'bg-red-500' : type === 'green' ? 'bg-green-500' : type === 'purple' ? 'bg-purple-500' : 'bg-blue-500';
            const html = `
                <div id="custom-message-box" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-[100] p-4 rounded-lg shadow-xl text-white ${bgColor} fade-in" style="min-width: 300px;">
                    <h4 class="font-bold text-lg">${title}</h4>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            setTimeout(() => {
                const box = document.getElementById('custom-message-box');
                if (box) box.remove();
            }, 5000);
        }

        // --- SLOT GENERATION & INTERACTION (Minor update to remove loading) ---

        function generatePickleballSlots() {
            const container = document.getElementById('pickleballSlots');
            const date = document.getElementById('pickleballDate').value;
            const courtType = document.getElementById('courtType').value;
            
            // Remove loading indicator once data is loaded
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.remove();

            container.innerHTML = '';
            
            for (let hour = 7; hour <= 22; hour++) {
                const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
                const slotId = `pickleball-${courtType}-${date}-${timeSlot}`;
                
                // Check current status from the main bookings array (now Firebase-synced)
                const currentBooking = bookings.find(b => b.id === slotId);
                const isBookedConfirmed = currentBooking && currentBooking.status === 'confirmed';
                const isBookedPending = currentBooking && currentBooking.status === 'pending';
                
                // Check if currently selected by this user (for visual cue before adding to cart)
                const isSelectedByCurrentUser = selectedSlots.includes(slotId);
                
                const button = document.createElement('button');
                button.textContent = timeSlot;
                button.disabled = isBookedConfirmed || (isBookedPending && currentBooking.user !== currentUser.id); 
                
                let buttonClass = 'slot-available';

                if (isBookedConfirmed) {
                    buttonClass = 'slot-booked';
                } else if (isBookedPending) {
                    buttonClass = 'slot-pending';
                    // Allow the user who placed the pending booking to interact (e.g. view cart)
                    if (currentBooking.user === currentUser.id) {
                         button.disabled = false;
                    }
                } else if (isSelectedByCurrentUser) {
                    // Only applies to truly available slots the user has clicked
                    buttonClass = 'slot-available-selected';
                }
                
                button.className = `px-3 py-2 rounded-lg font-medium text-sm transition-colors text-white shadow-md ${buttonClass} ${button.disabled ? 'cursor-not-allowed opacity-80' : 'hover:opacity-90'}`;

                if (!button.disabled && !isBookedPending && !isBookedConfirmed) {
                    button.onclick = () => selectSlot(slotId);
                } else if (isBookedPending && currentBooking.user === currentUser.id) {
                    button.onclick = () => showMessage('Pending Slot', 'This slot is held for you. Complete the booking in your cart!', 'purple');
                }

                container.appendChild(button);
            }
        }

        function selectSlot(slotId) {
            const index = selectedSlots.indexOf(slotId);
            
            if (index > -1) {
                selectedSlots.splice(index, 1);
            } else {
                if (selectedSlots.length >= 2) {
                    showMessage('Limit Reached', 'You can only select a maximum of 2 slots per transaction.', 'red');
                    return;
                }
                selectedSlots.push(slotId);
            }
            
            updateCartDisplay();
            generatePickleballSlots();
        }

        function addSelectedToCart() {
            if (selectedSlots.length === 0) {
                showMessage('No Selection', 'Please select at least one time slot first.', 'red');
                return;
            }
            
            pendingBookingDraft = [];
            
            const date = document.getElementById('pickleballDate').value;
            const courtType = document.getElementById('courtType').value;
            
            selectedSlots.forEach(slotId => {
                const timeSlot = slotId.split('-').pop();
                
                const bookingDraft = {
                    id: slotId,
                    sport: 'pickleball',
                    venue: courtType,
                    date: date,
                    time: timeSlot,
                    price: SLOT_PRICE,
                    user: currentUser.id,
                    customerName: null,
                    customerWhatsapp: null,
                    bookingTime: new Date().toISOString(),
                    status: 'pending-draft'
                };
                pendingBookingDraft.push(bookingDraft);
            });
            
            selectedSlots = [];

            updateCartDisplay();
            showMessage('‚úÖ Slot(s) Added to Cart', `${pendingBookingDraft.length} slot(s) moved to 'Your Cart'. Click 'Confirm Booking & Enter Details' to proceed.`, 'green');
            generatePickleballSlots();
        }

        function removeFromCart(index) {
            pendingBookingDraft.splice(index, 1);
            updateCartDisplay();
            generatePickleballSlots();
        }

        function updateCartDisplay() {
            const container = document.getElementById('cartItems');
            const totalElement = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (pendingBookingDraft.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-base">No slots currently selected.</p>';
                totalElement.textContent = '‚Çπ0';
                checkoutBtn.disabled = true;
                return;
            }
            
            container.innerHTML = pendingBookingDraft.map((item, index) => `
                <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-1">
                            <span class="font-bold text-lg text-gray-800">Pickleball</span>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-medium capitalize">${item.venue}</span>
                        </div>
                        <div class="space-y-0.5 text-gray-700">
                            <span class="text-sm font-semibold">üìÖ ${formatDateToDisplay(item.date)}</span>
                            <span class="text-sm font-semibold ml-3">‚è∞ ${item.time}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="font-bold text-xl text-purple-600">‚Çπ${item.price}</span>
                        <button onclick="removeFromCart(${index})" class="bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-800 p-2 rounded-full transition-colors">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
            
            const total = pendingBookingDraft.reduce((sum, item) => sum + item.price, 0);
            totalElement.textContent = `‚Çπ${total}`;
            checkoutBtn.disabled = false;
        }
        
        // --- CHECKOUT & WHATSAPP FUNCTIONS ---

        function showUserDetailsForm() {
            if (pendingBookingDraft.length === 0) return;
            document.getElementById('userDetailsModal').classList.remove('hidden');
            document.getElementById('userDetailsModal').classList.add('flex');
            document.getElementById('customerName').focus();
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
            document.getElementById('userDetailsModal').classList.remove('flex');
        }

        async function submitUserDetails() {
            const name = document.getElementById('customerName').value.trim();
            const whatsapp = document.getElementById('customerWhatsapp').value.trim();
            
            if (!name || whatsapp.length !== 10 || isNaN(whatsapp)) {
                showMessage('Missing Details', 'Please enter your full name and a valid 10-digit WhatsApp number.', 'red');
                return;
            }
            
            const total = pendingBookingDraft.reduce((sum, item) => sum + item.price, 0);
            const bookingDetailsText = pendingBookingDraft.map(item => 
                `*${item.venue}* Court on *${formatDateToDisplay(item.date)}* at *${item.time}* (‚Çπ${item.price})`
            ).join('%0A- '); 
            
            // 1. Convert Draft to PENDING Bookings (Yellow Status) and SAVE TO FIREBASE
            const newPendingBookings = pendingBookingDraft.map(draft => ({
                ...draft, 
                customerName: name,
                customerWhatsapp: whatsapp,
                status: 'pending' // Officially pending now, visible to all as yellow
            }));

            // Add new bookings to the global array (which will be saved to Firebase)
            newPendingBookings.forEach(newBooking => {
                bookings = bookings.filter(b => b.id !== newBooking.id); 
                bookings.push(newBooking);
            });
            
            await saveBookings(); // üü¢ SAVE to Firestore

            // 2. Open WhatsApp link (Customer to Admin)
            const whatsappMessage = 
                `*NEW BOOKING REQUEST - PLEASE CONFIRM*%0A%0A` +
                `üë§ *Customer:* ${name}%0A` +
                `üìû *WhatsApp:* +91${whatsapp}%0A%0A` +
                `üéæ *Booking Details (Total ‚Çπ${total}):*%0A` +
                `- ${bookingDetailsText}%0A%0A` +
                `_Kindly confirm this booking in the Admin Dashboard at your earliest convenience._`;

            const whatsappURL = `https://wa.me/${ADMIN_WHATSAPP}?text=${whatsappMessage}`;
            window.open(whatsappURL, '_blank', 'noopener,noreferrer');

            // 3. Cleanup UI
            pendingBookingDraft = []; 
            closeUserDetailsModal();
            updateCartDisplay();
            generatePickleballSlots(); // Refresh slots to show yellow status (synced from Firebase)

            showMessage('Booking Request Sent!', 'The slots are temporarily held (Yellow). The Admin must confirm them to secure your booking. WhatsApp chat opened.', 'purple');
        }

        // --- ADMIN FUNCTIONS (Updated to call saveBookings) ---
        
        // ... (checkAdminAccess, showAdminLogin functions are unchanged) ...
        
        let adminClickCount = 0;
        let adminTimeout = null;
        const ADMIN_ACCESS_CLICKS = 5;
        const CLICK_TIMEOUT_MS = 1500; 

        function checkAdminAccess() {
            adminClickCount++;

            if (adminTimeout) {
                clearTimeout(adminTimeout);
            }

            adminTimeout = setTimeout(() => {
                adminClickCount = 0;
            }, CLICK_TIMEOUT_MS);

            if (adminClickCount >= ADMIN_ACCESS_CLICKS) {
                adminClickCount = 0; 
                clearTimeout(adminTimeout);
                showAdminLogin();
            }
        }
        
        function showAdminLogin() {
            const password = prompt('üîê Enter Admin Password:\n\n(Hint: area51admin)');
            if (password === 'area51admin') {
                document.getElementById('bookingSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                updateAdminDashboard();
                showMessage('Welcome Admin!', 'You have successfully accessed the dashboard.', 'green');
            } else if (password !== null) {
                showMessage('Access Denied', 'Invalid password! Access attempt logged.', 'red');
            }
        }

        function updateAdminDashboard() {
            const pendingCount = bookings.filter(b => b.status === 'pending').length;
            const confirmedBookings = bookings.filter(b => b.status === 'confirmed');
            const confirmedCount = confirmedBookings.length;
            const totalRevenue = confirmedBookings.reduce((sum, b) => sum + b.price, 0);
            
            document.getElementById('pendingBookingsCount').textContent = pendingCount;
            document.getElementById('confirmedBookingsCount').textContent = confirmedCount;
            document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue}`;
            
            const tableBody = document.getElementById('bookingsTable');
            const allBookings = [...bookings].sort((a, b) => new Date(a.date) - new Date(b.date) || a.time.localeCompare(b.time));

            if (allBookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No bookings yet</td></tr>';
            } else {
                tableBody.innerHTML = allBookings.map((booking, index) => `
                    <tr class="transition duration-100 ${booking.status === 'pending' ? 'bg-yellow-100 hover:bg-yellow-200' : 'bg-red-50 hover:bg-red-100'}">
                        <td class="border-b px-3 py-3">
                            <span class="font-semibold">${booking.customerName || 'N/A'}</span>
                            <div class="text-xs text-gray-500">+91${booking.customerWhatsapp || 'N/A'}</div>
                        </td>
                        <td class="border-b px-3 py-3">${formatDateToDisplay(booking.date)} @ ${booking.time}</td>
                        <td class="border-b px-3 py-3 capitalize">${booking.venue}</td>
                        <td class="border-b px-3 py-3 font-bold">‚Çπ${booking.price}</td>
                        <td class="border-b px-3 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${booking.status === 'confirmed' ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'}">
                                ${booking.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="border-b px-3 py-3 space-y-1">
                            ${booking.status === 'pending' ? `
                                <button onclick="confirmBookingAdmin('${booking.id}')" class="w-full bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-medium transition shadow-sm">
                                    Confirm & Notify
                                </button>` : `<button class="w-full bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs font-medium cursor-not-allowed">Confirmed</button>`
                            }
                            <button onclick="cancelBookingAdmin('${booking.id}')" class="w-full bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium transition shadow-sm">
                                Cancel
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function confirmBookingAdmin(slotId) {
            const bookingIndex = bookings.findIndex(b => b.id === slotId);
            
            if (bookingIndex === -1) {
                showMessage('Error', 'Booking not found!', 'red');
                return;
            }

            const booking = bookings[bookingIndex];

            if (booking.status === 'confirmed') {
                showMessage('Already Confirmed', 'This booking is already confirmed!', 'blue');
                return;
            }
            
            if (window.confirm(`Confirm booking for ${booking.customerName} on ${formatDateToDisplay(booking.date)} at ${booking.time}?`)) {
                
                // 1. Update status to 'confirmed' (Red) and SAVE TO FIREBASE
                bookings[bookingIndex].status = 'confirmed';
                await saveBookings(); // üü¢ SAVE to Firestore
                
                // 2. Open Admin to Customer WhatsApp link
                const customerMessage = `üéâ *AREA 51 BOOKING CONFIRMATION* üéâ%0A%0A` +
                                        `Hi ${booking.customerName}! Great News! Your *Pickleball* booking is officially *CONFIRMED*!%0A%0A` +
                                        `Details:%0A` +
                                        `üìÖ Date: ${formatDateToDisplay(booking.date)}%0A` +
                                        `‚è∞ Time: ${booking.time}%0A` +
                                        `üìç Venue: ${booking.venue.toUpperCase()}%0A` +
                                        `üí∞ Amount: ‚Çπ${booking.price} (If paid, else payment due on arrival)%0A%0A` +
                                        `*Find our location here:* ${AREA_51_LOCATION}%0A%0A` + 
                                        `We look forward to seeing you. Let us know if you have any questions!%0A%0A` +
                                        `Area 51 Sports Team`;
                
                const customerWhatsappNumber = `91${booking.customerWhatsapp}`; 
                const whatsappURL = `https://wa.me/${customerWhatsappNumber}?text=${customerMessage}`;
                window.open(whatsappURL, '_blank', 'noopener,noreferrer');

                // 3. Refresh UI
                updateAdminDashboard();
                generatePickleballSlots();
                showMessage('Confirmed!', `Booking Confirmed for ${booking.customerName}. WhatsApp message opened to notify customer.`, 'green');
            }
        }

        async function cancelBookingAdmin(slotId) {
            const bookingIndex = bookings.findIndex(b => b.id === slotId);
            
            if (bookingIndex === -1) {
                showMessage('Error', 'Booking not found!', 'red');
                return;
            }

            const booking = bookings[bookingIndex];

            if (window.confirm(`Are you sure you want to CANCEL the ${booking.status.toUpperCase()} booking for ${booking.customerName} on ${formatDateToDisplay(booking.date)} at ${booking.time}?`)) {
                
                // Remove booking from array and SAVE TO FIREBASE
                bookings.splice(bookingIndex, 1);
                await saveBookings(); // üü¢ SAVE to Firestore
                
                const cancellationMessage = `‚ùå *BOOKING CANCELLED* ‚ùå%0A%0A` +
                                            `Hi ${booking.customerName}, your Pickleball booking for ${formatDateToDisplay(booking.date)} at ${booking.time} has been CANCELLED by the Admin.%0A%0A` +
                                            `_The slot is now available to book. Please contact us if you need assistance._%0A%0A` +
                                            `Area 51 Sports Team`;
                
                const customerWhatsappNumber = `91${booking.customerWhatsapp}`; 
                const whatsappURL = `https://wa.me/${customerWhatsappNumber}?text=${cancellationMessage}`;
                window.open(whatsappURL, '_blank', 'noopener,noreferrer');

                updateAdminDashboard();
                generatePickleballSlots();
                showMessage('Cancelled!', `Booking cancelled successfully! The slot is now available (Green). WhatsApp message opened to notify customer ${booking.customerName}.`, 'red');
            }
        }

        function exitAdmin() {
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('bookingSection').classList.remove('hidden');
            showMessage('Exited Admin', 'You are back in the customer booking view.', 'blue');
        }

        function checkUrlForAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                showAdminLogin();
            }
        }
        
        // --- INITIALIZATION (Updated to use async function) ---

        document.addEventListener('DOMContentLoaded', async function() {
            const today = new Date().toISOString().split('T')[0];
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 7);
            const maxDateString = maxDate.toISOString().split('T')[0];
            
            document.getElementById('pickleballDate').value = today;
            document.getElementById('pickleballDate').min = today;
            document.getElementById('pickleballDate').max = maxDateString;
            
            // üü¢ STEP 1: Load data from Firebase (Wait for this to complete)
            await loadBookings(); 

            // STEP 2: Attach listeners and initialize UI based on loaded data
            document.getElementById('adminTrigger').addEventListener('click', checkAdminAccess);
            checkUrlForAdminAccess();

            generatePickleballSlots();
            updateCartDisplay(); 

            document.getElementById('pickleballDate').addEventListener('change', generatePickleballSlots);
            document.getElementById('courtType').addEventListener('change', generatePickleballSlots);
        });
    </script>
</body>
</html>
