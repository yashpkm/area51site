<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 51 - Pickleball Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Available: Green/Teal */
        .slot-available {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            cursor: pointer;
        }
        /* Confirmed/Booked: Red (This is the only database-level booked state now) */
        .slot-booked {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            cursor: not-allowed;
            opacity: 0.8;
        }
        /* Selected (Client-side Cart/Draft): Dark Teal */
        .slot-selected {
            background: linear-gradient(135deg, #0f766e, #0d9488);
            color: white;
            box-shadow: 0 0 0 3px #fbbf24 inset; /* Yellow border to signify selection */
        }
        .custom-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <header class="bg-black text-white p-4 shadow-xl sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex items-center justify-between flex-wrap gap-4">
            
            <!-- HIDDEN ADMIN ACCESS TRIGGER -->
            <div class="flex items-center space-x-3 cursor-pointer" id="adminTrigger">
                <div class="text-3xl">üéæ</div>
                <div>
                    <h1 class="text-lg sm:text-2xl font-extrabold">Area 51 Pickleball</h1>
                    <p class="text-xs sm:text-sm text-gray-400 hidden sm:block">Real-time Court Booking System</p>
                </div>
            </div>

            <!-- LOCATION AND WHATSAPP BUTTONS -->
            <div class="flex space-x-3">
                <a href="https://maps.app.goo.gl/5dwYtzEj3mLkPxSd7" target="_blank" 
                   class="flex items-center bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold px-3 py-2 rounded-lg transition-colors shadow-md">
                    <span class="text-lg mr-1">üìç</span> Location
                </a>
                <button onclick="contactAdmin()" 
                        class="flex items-center bg-green-500 hover:bg-green-600 text-white text-sm font-semibold px-3 py-2 rounded-lg transition-colors shadow-md">
                    <span class="text-lg mr-1">üí¨</span> WhatsApp Admin
                </button>
            </div>
            <div class="h-6 hidden sm:block"></div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto p-4 sm:p-6">
        
        <div id="bookingSection" class="">
            
            <div id="pickleballBooking" class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 mb-8 fade-in">
                <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Book Your Pickleball Court</h3>
                <div class="grid sm:grid-cols-2 gap-4 sm:gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Court Type</label>
                        <select id="courtType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition duration-150">
                            <option value="indoor">Indoor Court</option>
                            <option value="outdoor">Outdoor Court</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="pickleballDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition duration-150">
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="text-base sm:text-lg font-semibold mb-4 flex items-center space-x-3">
                        <span>Available Time Slots (‚Çπ500/hour)</span>
                        <span class="text-xs text-gray-500 font-normal">| Click to Add to Cart</span>
                    </h4>
                    <div id="pickleballSlots" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 sm:gap-3">
                        <p class="col-span-full text-center py-4 text-gray-500" id="loadingMessage">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-600 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Loading available slots...
                        </p>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg text-sm mb-6">
                    <p class="font-semibold text-blue-800 mb-1">Status Key:</p>
                    <div class="flex flex-wrap gap-4 text-xs">
                        <span class="px-2 py-1 rounded-full bg-green-500 text-white font-medium">Available (Click to Add)</span>
                        <span class="px-2 py-1 rounded-full bg-yellow-500 text-gray-800 font-medium border border-yellow-600">Selected in Cart</span>
                        <span class="px-2 py-1 rounded-full bg-red-600 text-white font-medium">Confirmed/Booked</span>
                    </div>
                </div>
                
            </div>

            <!-- Cart Section -->
            <div id="cartSection" class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 fade-in mb-8">
                <h3 class="text-2xl sm:text-3xl font-bold text-purple-600 mb-6 border-b pb-3 flex justify-between items-center">
                    Your Cart <span id="cartCount" class="text-lg bg-gray-200 text-gray-700 px-3 py-1 rounded-full font-semibold">0 Slots</span>
                </h3>
                
                <div id="cartTable" class="min-h-[50px]">
                    <p class="text-gray-500 text-center py-4">Your selected slots will appear here.</p>
                </div>
                
                <div class="flex justify-between items-center mt-6 pt-4 border-t">
                    <div class="text-xl font-bold text-gray-800">
                        Total: <span id="cartTotal" class="text-purple-600">‚Çπ0</span>
                    </div>
                    <button onclick="showUserDetailsForm()" id="confirmCartBtn" disabled 
                            class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold transition-colors shadow-lg disabled:bg-gray-400 disabled:shadow-none">
                        Confirm Booking
                    </button>
                </div>
            </div>
            <!-- End Cart Section -->

        </div>

        <!-- Admin Dashboard Section -->
        <div id="adminSection" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Admin Dashboard</h3>
                
                <!-- Stats -->
                <div class="grid sm:grid-cols-3 gap-4 sm:gap-6 mb-8">
                    <div class="bg-red-50 p-4 rounded-lg shadow-inner">
                        <h4 class="font-semibold text-red-800 text-sm">Total Active Bookings</h4>
                        <p class="text-xl sm:text-2xl font-bold text-red-600" id="confirmedBookingsCount">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg shadow-inner col-span-2">
                        <h4 class="font-semibold text-green-800 text-sm">Total Revenue (Based on Confirmed)</h4>
                        <p class="text-xl sm:text-2xl font-bold text-green-600" id="totalRevenue">‚Çπ0</p>
                    </div>
                </div>
                
                <!-- Bookings Table -->
                <div class="mb-6">
                    <h4 class="text-lg sm:text-xl font-semibold mb-3">All Confirmed Bookings</h4>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full border-collapse text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border-b px-3 py-3 text-left">Customer</th>
                                    <th class="border-b px-3 py-3 text-left">Date & Time</th>
                                    <th class="border-b px-3 py-3 text-left">Venue</th>
                                    <th class="border-b px-3 py-3 text-left">Price</th>
                                    <th class="border-b px-3 py-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                                <tr>
                                    <td colspan="5" class="px-4 py-4 text-center text-gray-500">No confirmed bookings yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <button onclick="exitAdmin()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                    Exit Admin
                </button>
            </div>
        </div>
    </div>

    <!-- User Details Form Modal -->
    <div id="userDetailsModal" class="fixed inset-0 custom-modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 sm:p-8 max-w-lg mx-4 text-center fade-in shadow-2xl">
            <h2 class="text-2xl font-bold text-purple-600 mb-4">Finalize Your Booking</h2>
            <p class="text-gray-600 mb-6">You are confirming <span id="modalCartCount" class="font-semibold text-purple-700">0</span> slots for a total of <span id="modalCartTotal" class="font-bold text-purple-700">‚Çπ0</span>. This action instantly books the slots.</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">Your Full Name</label>
                    <input type="text" id="customerName" placeholder="E.g., John Doe" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div>
                    <label for="customerWhatsapp" class="block text-sm font-medium text-gray-700 mb-2">WhatsApp Number (+91)</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-100 text-gray-500 font-semibold">+91</span>
                        <input type="tel" id="customerWhatsapp" placeholder="10-digit number" 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-purple-500 transition"
                               maxlength="10" pattern="[0-9]{10}" required>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end space-x-3">
                <button onclick="closeUserDetailsModal()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition">
                    Go Back (Edit Cart)
                </button>
                <button onclick="submitBookingRequest()" id="submitDetailsBtn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition disabled:bg-gray-400">
                    Confirm & Pay (Final Step)
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-3">By confirming, these slots are instantly marked as booked on the system.</p>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIGURATION ---
        
        let db;
        let auth;
        let userId = 'loading';
        let bookings = []; // Now populated by Firestore snapshot (only 'confirmed' bookings)
        let pendingBookingDraft = []; // Client-side array of slot IDs in the cart
        
        const SLOT_PRICE = 500;
        const ADMIN_WHATSAPP = '917972409893';
        const AREA_51_LOCATION = 'https://maps.app.goo.gl/5dwYtzEj3mLkPxSd7'; 

        // --- UTILITIES ---

        function formatDateToDisplay(dateString) {
            if (!dateString) return 'Invalid Date';
            try {
                const date = new Date(dateString + 'T00:00:00');
                const day = date.getDate().toString().padStart(2, '0');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = monthNames[date.getMonth()];
                return `${day}/${month}`;
            } catch (error) {
                return 'Invalid Date';
            }
        }
        
        function showMessage(title, message, type = 'blue') {
            const bgColor = type === 'red' ? 'bg-red-500' : type === 'green' ? 'bg-green-500' : type === 'purple' ? 'bg-purple-600' : 'bg-blue-500';
            const html = `
                <div id="custom-message-box" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-[100] p-4 rounded-lg shadow-xl text-white ${bgColor} fade-in" style="min-width: 300px;">
                    <h4 class="font-bold text-lg">${title}</h4>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            setTimeout(() => {
                const box = document.getElementById('custom-message-box');
                if (box) box.remove();
            }, 5000);
        }

        function contactAdmin() {
            const message = "Hi, I have a general question about court bookings at Area 51 Pickleball.";
            const whatsappURL = `https://wa.me/${ADMIN_WHATSAPP}?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        }

        // --- FIREBASE INITIALIZATION ---

        async function initFirebase() {
            try {
                // Global variables are provided by the canvas environment
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set Firestore logging level to debug
                setLogLevel('debug');
                
                // 1. Sign in
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 2. Auth listener to set global userId and start data listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with ID:", userId);
                        startBookingListener(appId);
                        
                        // Load stored user details if available
                        const storedName = localStorage.getItem(`${userId}_name`);
                        const storedWhatsapp = localStorage.getItem(`${userId}_whatsapp`);
                        if (storedName) document.getElementById('customerName').value = storedName;
                        if (storedWhatsapp) document.getElementById('customerWhatsapp').value = storedWhatsapp;

                    } else {
                        console.error("Authentication failed or not ready.");
                        userId = 'unauthenticated';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loadingMessage').textContent = 'Error loading data. Please check console.';
            }
        }

        // --- FIREBASE REAL-TIME LISTENER ---

        function startBookingListener(appId) {
            const collectionPath = `/artifacts/${appId}/public/data/bookings`;
            const q = query(collection(db, collectionPath));
            
            onSnapshot(q, (snapshot) => {
                bookings = [];
                snapshot.forEach((doc) => {
                    // Only include CONFIRMED bookings in the main list
                    const data = doc.data();
                    if (data.status === 'confirmed') {
                         bookings.push({ ...data, fsId: doc.id });
                    }
                });
                
                console.log("Realtime confirmed bookings updated:", bookings.length);
                generatePickleballSlots();
                updateCartUI(); // Update slots and cart
                
                // Only update admin dashboard if it's visible
                if (!document.getElementById('adminSection').classList.contains('hidden')) {
                    updateAdminDashboard();
                }
                document.getElementById('loadingMessage').classList.add('hidden');

            }, (error) => {
                console.error("Firestore listen failed:", error);
                document.getElementById('loadingMessage').textContent = 'Connection error. Please refresh.';
            });
        }
        
        // --- SLOT GENERATION & INTERACTION ---

        function generatePickleballSlots() {
            const container = document.getElementById('pickleballSlots');
            const date = document.getElementById('pickleballDate').value;
            const courtType = document.getElementById('courtType').value;
            
            container.innerHTML = '';
            
            for (let hour = 7; hour <= 22; hour++) {
                const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
                const slotId = `${courtType}-${date}-${timeSlot}`;
                
                // 1. Check current confirmed status from Firestore
                const isBookedConfirmed = bookings.some(b => b.id === slotId);
                
                // 2. Check if currently in client-side cart
                const isInCart = pendingBookingDraft.includes(slotId);
                
                const button = document.createElement('button');
                button.textContent = timeSlot;
                
                let buttonClass = 'slot-available';
                let isDisabled = false;

                if (isBookedConfirmed) {
                    buttonClass = 'slot-booked';
                    isDisabled = true;
                } else if (isInCart) {
                    buttonClass = 'slot-selected';
                    // Not disabled, can be unselected
                } else {
                    buttonClass = 'slot-available';
                }
                
                button.className = `slot-btn px-3 py-2 rounded-lg font-medium text-sm transition-colors shadow-md ${buttonClass} ${isDisabled ? 'cursor-not-allowed opacity-80' : 'hover:opacity-90'}`;
                button.disabled = isDisabled;
                button.dataset.slotId = slotId;

                if (!isDisabled) {
                    button.onclick = () => toggleSlotSelection(slotId);
                }

                container.appendChild(button);
            }
        }
        
        function toggleSlotSelection(slotId) {
            const index = pendingBookingDraft.indexOf(slotId);
            
            if (index > -1) {
                // Remove from cart
                pendingBookingDraft.splice(index, 1);
            } else {
                // Add to cart
                pendingBookingDraft.push(slotId);
            }
            
            // Re-render slots and cart UI
            generatePickleballSlots(); 
            updateCartUI();
        }

        // --- CART UI FUNCTIONS ---

        function updateCartUI() {
            const cartContainer = document.getElementById('cartTable');
            const total = pendingBookingDraft.length * SLOT_PRICE;
            const btn = document.getElementById('confirmCartBtn');

            document.getElementById('cartCount').textContent = `${pendingBookingDraft.length} Slot${pendingBookingDraft.length !== 1 ? 's' : ''}`;
            document.getElementById('cartTotal').textContent = `‚Çπ${total}`;
            
            btn.disabled = pendingBookingDraft.length === 0;

            if (pendingBookingDraft.length === 0) {
                cartContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Your selected slots will appear here.</p>';
                return;
            }

            // Generate detailed cart items
            const cartItemsHtml = pendingBookingDraft.map(id => {
                const [venue, date, time] = id.split('-');
                return `
                    <div class="flex justify-between items-center p-3 mb-2 bg-gray-50 rounded-lg shadow-sm">
                        <div class="text-sm font-medium">
                            ${formatDateToDisplay(date)} @ ${time} (${venue.toUpperCase()})
                        </div>
                        <div class="font-bold text-gray-700">
                            ‚Çπ${SLOT_PRICE}
                        </div>
                        <button onclick="toggleSlotSelection('${id}')" class="text-red-500 hover:text-red-700 text-sm font-semibold transition">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
            
            cartContainer.innerHTML = cartItemsHtml;
        }


        // --- BOOKING CONFIRMATION FLOW (MODIFIED) ---

        function showUserDetailsForm() {
            if (pendingBookingDraft.length === 0) {
                showMessage('Cart Empty', 'Please select at least one slot to book.', 'red');
                return;
            }
            const total = pendingBookingDraft.length * SLOT_PRICE;
            
            document.getElementById('modalCartCount').textContent = `${pendingBookingDraft.length}`;
            document.getElementById('modalCartTotal').textContent = `‚Çπ${total}`;
            
            document.getElementById('userDetailsModal').classList.remove('hidden');
            document.getElementById('userDetailsModal').classList.add('flex');
            document.getElementById('customerName').focus();
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
            document.getElementById('userDetailsModal').classList.remove('flex');
        }

        async function submitBookingRequest() {
            if (pendingBookingDraft.length === 0 || userId === 'loading' || userId === 'unauthenticated') {
                showMessage('Error', 'No slots in cart or system not ready. Please try again.', 'red');
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();
            const whatsapp = document.getElementById('customerWhatsapp').value.trim();
            
            if (!name || whatsapp.length !== 10 || isNaN(whatsapp)) {
                showMessage('Missing Details', 'Please enter your full name and a valid 10-digit WhatsApp number.', 'red');
                return;
            }
            
            // Save details to localStorage for next time
            localStorage.setItem(`${userId}_name`, name);
            localStorage.setItem(`${userId}_whatsapp`, whatsapp);
            
            const submitBtn = document.getElementById('submitDetailsBtn');
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `/artifacts/${appId}/public/data/bookings`;
                const batch = writeBatch(db);
                
                const bookedSlots = [];

                // 1. Process all slots in the cart
                for (const slotId of pendingBookingDraft) {
                    // Quick check if another user booked it in the last few seconds
                    const isClashed = bookings.some(b => b.id === slotId);
                    if (isClashed) {
                         // Skip this slot but process others
                        showMessage('Slot Clash', `Slot ${slotId.split('-')[2]} was just booked by another user and will be removed from your cart.`, 'red');
                        continue;
                    }
                    
                    const [venue, date, time] = slotId.split('-');
                    
                    // Use the slotId as the Firestore document ID to ensure uniqueness/overwrite protection
                    const bookingRef = doc(db, collectionPath, slotId);
                    
                    batch.set(bookingRef, {
                        id: slotId, 
                        sport: 'pickleball',
                        venue: venue,
                        date: date,
                        time: time,
                        price: SLOT_PRICE,
                        user: userId, // User who requested the booking
                        customerName: name,
                        customerWhatsapp: whatsapp,
                        bookingTime: serverTimestamp(),
                        status: 'confirmed' // INSTANTLY CONFIRMED as per user request
                    });
                    
                    bookedSlots.push({ venue, date, time });
                }

                if (bookedSlots.length === 0) {
                    showMessage('Booking Failed', 'All slots were taken or no valid slots remained in cart.', 'red');
                    closeUserDetailsModal();
                    pendingBookingDraft = [];
                    generatePickleballSlots();
                    updateCartUI();
                    return;
                }

                // 2. Commit the batch write to Firestore (all or nothing)
                await batch.commit();

                // 3. --- WhatsApp User Notification (to Admin) ---
                const slotSummary = bookedSlots.map(s => `- ${s.venue} on ${formatDateToDisplay(s.date)} @ ${s.time}`).join('%0A');
                const totalAmount = bookedSlots.length * SLOT_PRICE;
                
                const whatsappMessage = 
                    `‚úÖ *NEW CONFIRMED BOOKING - ACTION REQUIRED* ‚úÖ%0A%0A` +
                    `üë§ *Customer:* ${name}%0A` +
                    `üìû *WhatsApp:* +91${whatsapp}%0A` +
                    `üí∏ *Total Amount:* ‚Çπ${totalAmount}%0A%0A` +
                    `üéæ *Booked Slots:*%0A` +
                    `${slotSummary}%0A%0A` +
                    `_Please contact the customer to confirm payment/details. The slot is now held on the system._`;

                const whatsappURL = `https://wa.me/${ADMIN_WHATSAPP}?text=${whatsappMessage}`;
                window.open(whatsappURL, '_blank', 'noopener,noreferrer');

                // 4. --- UI Cleanup ---
                closeUserDetailsModal();
                pendingBookingDraft = []; // Clear cart after successful booking
                generatePickleballSlots();
                updateCartUI(); 
                showMessage('Booking Confirmed!', `Your ${bookedSlots.length} slot(s) are now CONFIRMED! WhatsApp chat opened to notify Admin.`, 'green');

            } catch (error) {
                console.error("Error submitting confirmed booking:", error);
                showMessage('Booking Failed', 'Could not save booking. Please check your connection.', 'red');
            } finally {
                submitBtn.textContent = 'Confirm & Pay (Final Step)';
                submitBtn.disabled = false;
            }
        }

        // --- ADMIN FUNCTIONS ---
        
        let adminClickCount = 0;
        let adminTimeout = null;
        const ADMIN_ACCESS_CLICKS = 5;
        const CLICK_TIMEOUT_MS = 1500; 

        function checkAdminAccess() {
            adminClickCount++;

            if (adminTimeout) {
                clearTimeout(adminTimeout);
            }

            adminTimeout = setTimeout(() => {
                adminClickCount = 0;
            }, CLICK_TIMEOUT_MS);

            if (adminClickCount >= ADMIN_ACCESS_CLICKS) {
                adminClickCount = 0;
                clearTimeout(adminTimeout);
                showAdminLogin();
            }
        }
        
        function showAdminLogin() {
            // NOTE: Using window.prompt is generally discouraged, but used here for simple Admin login.
            const password = prompt('üîê Enter Admin Password:\n\n(Hint: area51admin)');
            if (password === 'area51admin') {
                document.getElementById('bookingSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                updateAdminDashboard(); 
                showMessage('Welcome Admin!', 'You have successfully accessed the dashboard.', 'green');
            } else if (password !== null) {
                showMessage('Access Denied', 'Invalid password!', 'red');
            }
        }

        function updateAdminDashboard() {
            // Since all bookings in the list are now 'confirmed', we just list them
            const confirmedBookings = bookings;
            
            const confirmedCount = confirmedBookings.length;
            const totalRevenue = confirmedBookings.reduce((sum, b) => sum + b.price, 0);
            
            document.getElementById('confirmedBookingsCount').textContent = confirmedCount;
            document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue}`;
            
            const tableBody = document.getElementById('bookingsTable');
            const allBookings = [...confirmedBookings].sort((a, b) => {
                // Sort by date, then time
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                return a.time.localeCompare(b.time);
            });

            if (allBookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">No confirmed bookings yet</td></tr>';
            } else {
                tableBody.innerHTML = allBookings.map((booking, index) => {
                    // Since all are confirmed, the status is always RED
                    const statusClass = 'bg-red-200 text-red-800';
                    const rowClass = 'bg-red-50 hover:bg-red-100';

                    return `
                        <tr class="transition duration-100 ${rowClass}">
                            <td class="border-b px-3 py-3">
                                <span class="font-semibold">${booking.customerName || 'N/A'}</span>
                                <div class="text-xs text-gray-500">+91${booking.customerWhatsapp || 'N/A'}</div>
                                <div class="text-[10px] text-gray-400 truncate w-32">${booking.user}</div>
                            </td>
                            <td class="border-b px-3 py-3">${formatDateToDisplay(booking.date)} @ ${booking.time}</td>
                            <td class="border-b px-3 py-3 capitalize">${booking.venue}</td>
                            <td class="border-b px-3 py-3 font-bold">‚Çπ${booking.price}</td>
                            <td class="border-b px-3 py-3 space-y-1">
                                <button onclick="cancelBookingAdmin('${booking.fsId}', '${booking.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-medium transition shadow-sm">
                                    Cancel & Notify
                                </button>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass} block mt-1">CONFIRMED</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        async function cancelBookingAdmin(fsId, slotId) {
            const booking = bookings.find(b => b.fsId === fsId);
            
            if (!booking) { showMessage('Error', 'Booking not found!', 'red'); return; }

            // Replace standard alert with custom confirmation
            const confirmed = window.confirm(`Are you sure you want to CANCEL this booking for ${booking.customerName} on ${formatDateToDisplay(booking.date)} at ${booking.time}? This will free the slot immediately.`);
            
            if (!confirmed) { return; }

            const cancelBtn = document.querySelector(`button[onclick="cancelBookingAdmin('${fsId}', '${slotId}')"]`);
            if (cancelBtn) { cancelBtn.textContent = 'Processing...'; cancelBtn.disabled = true; }

            try {
                // 1. Delete booking from Firestore (using fsId)
                const bookingRef = doc(db, `/artifacts/${__app_id}/public/data/bookings`, fsId);
                await setDoc(bookingRef, { status: 'cancelled', cancelledByAdmin: true, cancellationTime: serverTimestamp() }, { merge: true });

                // 2. Open Admin to Customer WhatsApp link
                const cancellationMessage = `‚ùå *BOOKING CANCELLED* ‚ùå%0A%0A` +
                                            `Hi ${booking.customerName}, your Pickleball booking for ${formatDateToDisplay(booking.date)} at ${booking.time} has been CANCELLED by the Admin. %0A%0A` +
                                            `_The slot is now available to book. Please contact us if you need assistance._%0A%0A` +
                                            `Area 51 Sports Team`;
                
                const customerWhatsappNumber = `91${booking.customerWhatsapp}`; 
                const whatsappURL = `https://wa.me/${customerWhatsappNumber}?text=${cancellationMessage}`;
                window.open(whatsappURL, '_blank', 'noopener,noreferrer');

                // UI update happens automatically via onSnapshot
                showMessage('Cancelled!', `Booking cancelled successfully! The slot is now available (Green). WhatsApp message opened to notify customer.`, 'red');
            } catch (error) {
                console.error("Error cancelling booking:", error);
                showMessage('Error', 'Failed to cancel booking. Please try again.', 'red');
            } 
        }

        function exitAdmin() {
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('bookingSection').classList.remove('hidden');
            showMessage('Exited Admin', 'You are back in the customer booking view.', 'blue');
        }

        function checkUrlForAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                showAdminLogin();
            }
        }
        
        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 7);
            const maxDateString = maxDate.toISOString().split('T')[0];
            
            document.getElementById('pickleballDate').value = today;
            document.getElementById('pickleballDate').min = today;
            document.getElementById('pickleballDate').max = maxDateString;
            
            document.getElementById('adminTrigger').addEventListener('click', checkAdminAccess);
            
            document.getElementById('pickleballDate').addEventListener('change', generatePickleballSlots);
            document.getElementById('courtType').addEventListener('change', generatePickleballSlots);
            
            initFirebase();
            checkUrlForAdminAccess();
        });
    </script>
</body>
</html>

